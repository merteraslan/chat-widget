<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Messages Demo - Chat Widget</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
            min-height: 100vh;
        }
        
        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        
        .demo-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .demo-header h1 {
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .demo-header p {
            color: #6b7280;
            font-size: 16px;
        }
        
        .demo-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .demo-section h3 {
            margin-top: 0;
            color: #374151;
        }
        
        .demo-section pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
        }
        
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 8px 4px;
            transition: background 0.2s;
        }
        
        .test-button:hover {
            background: #5a67d8;
        }
        
        .note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            color: #92400e;
        }

        .success-note {
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 6px;
            padding: 12px;
            margin: 16px 0;
            color: #166534;
        }

        /* Additional styles for better demo experience */
        #chat-messages {
            max-height: 400px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .demo-button-active {
            background: #4338ca !important;
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>ü§ñ Interactive Messages Demo</h1>
            <p>Test interactive messages including articles, forms, and cards in your Chat widget</p>
        </div>
        
        <div class="demo-section">
            <h3>üìã Webhook Response Formats</h3>
            <p><strong>Articles:</strong> To send an interactive article message, your webhook should return:</p>
            <pre>{
    "content": "articles",
    "content_type": "article",
    "content_attributes": {
        "items": [
            {
                "title": "API Quick Start Guide",
                "description": "A comprehensive guide to get you started with our API",
                "link": "https://docs.example.com/api-guide"
            },
            {
                "title": "Development Documentation",
                "description": "Complete development docs and best practices",
                "link": "https://docs.example.com/dev-docs"
            }
        ]
    }
}</pre>
            
            <p><strong>Forms:</strong> To send an interactive form message, use this format:</p>
            <pre>{
    "content": "Please fill out this contact form:",
    "content_type": "form",
    "content_attributes": {
        "form": {
            "title": "Contact Us",
            "description": "We'd love to hear from you!",
            "fields": [
                {
                    "id": "name",
                    "type": "text",
                    "label": "Full Name",
                    "placeholder": "Enter your name",
                    "required": true
                },
                {
                    "id": "email",
                    "type": "email",
                    "label": "Email",
                    "placeholder": "your@email.com",
                    "required": true
                },
                {
                    "id": "subject",
                    "type": "select",
                    "label": "Subject",
                    "required": true,
                    "options": [
                        {"value": "general", "label": "General Inquiry"},
                        {"value": "support", "label": "Support"}
                    ]
                },
                {
                    "id": "message",
                    "type": "textarea",
                    "label": "Message",
                    "placeholder": "How can we help?",
                    "required": true
                }
            ],
            "submitLabel": "Send Message"
        }
    }
}</pre>
            
            <p><strong>Cards:</strong> To send interactive card messages with images:</p>
            <pre>{
    "content": "Check out these featured products:",
    "content_type": "card",
    "content_attributes": {
        "cards": {
            "title": "Featured Products",
            "cards": [
                {
                    "title": "Wireless Headphones",
                    "description": "Premium noise-canceling headphones",
                    "image": "https://example.com/headphones.jpg",
                    "link": "https://shop.example.com/headphones",
                    "linkText": "View Product",
                    "badge": "BESTSELLER",
                    "price": "$299"
                }
            ]
        }
    }
}</pre>
        </div>
        
        <div class="demo-section">
            <h3>üß™ Test Interactive Messages</h3>
            <p>Click these buttons to add different message types directly to the chat widget:</p>
            
            <button class="test-button" onclick="simulateInteractiveMessage('articles')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üì∞ Add Articles Message
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('guides')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üìñ Add Guides Message
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('contact-form')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üìù Add Contact Form
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('survey-form')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üìä Add Survey Form
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('product-cards')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üõçÔ∏è Add Product Cards
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('service-cards')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üéØ Add Service Cards
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('quick-replies')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                ‚ö° Add Quick Replies
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('support-options')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üÜò Add Support Options
            </button>
            
            <button class="test-button" onclick="simulateInteractiveMessage('regular')" onmousedown="this.classList.add('demo-button-active')" onmouseup="this.classList.remove('demo-button-active')">
                üí¨ Add Regular Message
            </button>
        </div>
        
        <div class="success-note">
            <strong>‚úÖ Widget Loaded!</strong> You should see the chat widget in the bottom-right corner. Use the buttons above to add interactive messages instantly, or type keywords like "articles", "guides", "contact", "survey", "products", or "services" in the chat for the same effect.
        </div>
        
        <div class="note">
            <strong>Note:</strong> In production, replace the mock webhook URL with your actual endpoint that returns the interactive message formats shown above. Forms can submit to any endpoint you specify in the <code>submitUrl</code> field. Card images should be hosted on a CDN or your server.
        </div>
        
        <div class="demo-section">
            <h3>üé® Widget Color Customization</h3>
            <p>Change the widget's color scheme to see how all interactive elements inherit the same colors:</p>
            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin: 16px 0;">
                <button onclick="changeWidgetColor('#242424')" style="background: #242424; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Default (Dark Grey)</button>
                <button onclick="changeWidgetColor('#000000')" style="background: #000000; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Black</button>
                <button onclick="changeWidgetColor('#dc2626')" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Red</button>
                <button onclick="changeWidgetColor('#059669')" style="background: #059669; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Green</button>
                <button onclick="changeWidgetColor('#3b82f6')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Blue</button>
                <button onclick="changeWidgetColor('#7c3aed')" style="background: #7c3aed; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Purple</button>
                <button onclick="changeWidgetColor('#f59e0b')" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Amber</button>
                <button onclick="changeWidgetColor('#ea580c')" style="background: #ea580c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Orange</button>
                <button onclick="changeWidgetColor('#0891b2')" style="background: #0891b2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Cyan</button>
            </div>
            <p style="font-size: 14px; color: #6b7280; margin-top: 8px;">
                <strong>Note:</strong> All interactive elements (buttons, forms, cards, badges) and the agent name will automatically inherit the selected color.
            </p>
        </div>
        
        <div class="demo-section">
            <h3>ü§ñ Agent Name Display</h3>
            <p>The demo bot uses <code>agentName: "Demo Bot"</code> so all AI messages are prefixed with <strong style="color: var(--demo-color, #242424);">Demo Bot:</strong> in the selected color.</p>
            <p style="font-size: 14px; color: #6b7280;">Try sending a message to see how agent responses are labeled with the agent name in bold and colored with the widget's primary color.</p>
        </div>
    </div>

    <!-- Load React from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Load the widget styles -->
    <link rel="stylesheet" href="./dist/main.css">

    <script>
        // Mock webhook server
        const mockWebhookResponses = {
            articles: {
                "content": "helpful articles",
                "content_type": "article", 
                "content_attributes": {
                    "items": [
                        {
                            "title": "API Quick Start Guide",
                            "description": "With this quickstart guide, we've tried to make it as easy as possible to get up and running with...",
                            "link": "https://docs.example.com/api-guide"
                        },
                        {
                            "title": "Development Documentation", 
                            "description": "Complete development docs and best practices for building amazing applications",
                            "link": "https://docs.example.com/dev-docs"
                        },
                        {
                            "title": "Integration Examples",
                            "description": "Real-world examples and code snippets to help you integrate quickly",
                            "link": "https://docs.example.com/examples"
                        }
                    ]
                }
            },
            guides: {
                "content": "helpful guides",
                "content_type": "article",
                "content_attributes": {
                    "items": [
                        {
                            "title": "Getting Started Guide",
                            "description": "Everything you need to know to get started with our platform",
                            "link": "https://help.example.com/getting-started"
                        },
                        {
                            "title": "Best Practices",
                            "description": "Tips and tricks from our experts to help you succeed",
                            "link": "https://help.example.com/best-practices"
                        }
                    ]
                }
            },
            "contact-form": {
                "content": "Please fill out this contact form:",
                "content_type": "form",
                "content_attributes": {
                    "form": {
                        "title": "Contact Us",
                        "description": "We'd love to hear from you! Please fill out the form below.",
                        "fields": [
                            {
                                "id": "name",
                                "type": "text",
                                "label": "Full Name",
                                "placeholder": "Enter your full name",
                                "required": true
                            },
                            {
                                "id": "email",
                                "type": "email",
                                "label": "Email Address",
                                "placeholder": "your@email.com",
                                "required": true
                            },
                            {
                                "id": "subject",
                                "type": "select",
                                "label": "Subject",
                                "required": true,
                                "options": [
                                    {"value": "general", "label": "General Inquiry"},
                                    {"value": "support", "label": "Technical Support"},
                                    {"value": "feedback", "label": "Feedback"}
                                ]
                            },
                            {
                                "id": "message",
                                "type": "textarea",
                                "label": "Message",
                                "placeholder": "Tell us how we can help...",
                                "required": true
                            },
                            {
                                "id": "newsletter",
                                "type": "checkbox",
                                "label": "Subscribe to our newsletter for updates"
                            }
                        ],
                        "submitLabel": "Send Message",
                        "submitUrl": "/api/contact-form"
                    }
                }
            },
            "survey-form": {
                "content": "Help us improve our service:",
                "content_type": "form",
                "content_attributes": {
                    "form": {
                        "title": "Quick Survey",
                        "description": "Your feedback helps us serve you better!",
                        "fields": [
                            {
                                "id": "satisfaction",
                                "type": "radio",
                                "label": "How satisfied are you with our service?",
                                "required": true,
                                "options": [
                                    {"value": "very-satisfied", "label": "Very Satisfied"},
                                    {"value": "satisfied", "label": "Satisfied"},
                                    {"value": "neutral", "label": "Neutral"},
                                    {"value": "dissatisfied", "label": "Dissatisfied"}
                                ]
                            },
                            {
                                "id": "recommendation",
                                "type": "select",
                                "label": "How likely are you to recommend us?",
                                "required": true,
                                "options": [
                                    {"value": "10", "label": "10 - Extremely likely"},
                                    {"value": "9", "label": "9 - Very likely"},
                                    {"value": "8", "label": "8 - Likely"},
                                    {"value": "7", "label": "7 - Somewhat likely"},
                                    {"value": "6", "label": "6 - Neutral"},
                                    {"value": "5", "label": "5 - Unlikely"}
                                ]
                            },
                            {
                                "id": "improvements",
                                "type": "textarea",
                                "label": "What could we improve?",
                                "placeholder": "Tell us what we could do better..."
                            },
                            {
                                "id": "contact-back",
                                "type": "checkbox",
                                "label": "It's okay to contact me about this feedback"
                            }
                        ],
                        "submitLabel": "Submit Survey"
                    }
                }
            },
            "product-cards": {
                "content": "Check out these featured products:",
                "content_type": "card",
                "content_attributes": {
                    "cards": {
                        "title": "Featured Products",
                        "description": "Our most popular items this month",
                        "cards": [
                            {
                                "title": "Wireless Noise-Canceling Headphones",
                                "description": "Premium audio experience with industry-leading noise cancellation and 30-hour battery life",
                                "image": "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300&h=200&fit=crop&crop=center",
                                "imageAlt": "Black wireless headphones",
                                "link": "https://example.com/headphones",
                                "linkText": "View Product",
                                "badge": "BESTSELLER",
                                "price": "$299"
                            },
                            {
                                "title": "Smart Fitness Watch",
                                "description": "Track your health and fitness with this advanced smartwatch featuring GPS and heart rate monitoring",
                                "image": "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=300&h=200&fit=crop&crop=center",
                                "imageAlt": "Silver smartwatch on wrist",
                                "link": "https://example.com/smartwatch",
                                "linkText": "Learn More",
                                "badge": "NEW",
                                "price": "$399"
                            },
                            {
                                "title": "Wireless Bluetooth Speaker",
                                "description": "Portable speaker with exceptional sound quality and 12-hour battery life",
                                "image": "https://images.unsplash.com/photo-1608043152269-423dbba4e7e1?w=300&h=200&fit=crop&crop=center",
                                "imageAlt": "Black bluetooth speaker",
                                "link": "https://example.com/speaker",
                                "linkText": "Shop Now",
                                "price": "$149"
                            }
                        ]
                    }
                }
            },
            "service-cards": {
                "content": "Explore our premium services:",
                "content_type": "card",
                "content_attributes": {
                    "cards": {
                        "title": "Our Services",
                        "description": "Professional solutions tailored to your needs",
                        "cards": [
                            {
                                "title": "Web Development",
                                "description": "Custom websites and web applications built with modern technologies and best practices",
                                "image": "https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=300&h=200&fit=crop&crop=center",
                                "imageAlt": "Code on computer screen",
                                "link": "https://example.com/web-development",
                                "linkText": "Get Quote",
                                "badge": "POPULAR"
                            },
                            {
                                "title": "Mobile App Development",
                                "description": "Native and cross-platform mobile applications for iOS and Android devices",
                                "image": "https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=300&h=200&fit=crop&crop=center",
                                "imageAlt": "Mobile app development",
                                "link": "https://example.com/mobile-development",
                                "linkText": "View Portfolio"
                            }
                        ]
                    }
                }
            },
            "quick-replies": {
                "content": "How can I help you today?",
                "content_type": "canned_response",
                "content_attributes": {
                    "responses": {
                        "title": "How can I help you today?",
                        "description": "Please select what you need help with, or feel free to type your own question:",
                        "responses": [
                            {
                                "id": "billing",
                                "text": "I have a question about billing",
                                "value": "billing_inquiry"
                            },
                            {
                                "id": "technical",
                                "text": "I need technical support",
                                "value": "technical_support"
                            },
                            {
                                "id": "general",
                                "text": "General information",
                                "value": "general_info"
                            }
                        ]
                    }
                }
            },
            "support-options": {
                "content": "What type of support do you need?",
                "content_type": "quick_reply",
                "content_attributes": {
                    "responses": {
                        "title": "Support Options",
                        "description": "Select the area where you need assistance, or describe your specific issue below:",
                        "responses": [
                            {
                                "id": "account",
                                "text": "Account & Profile",
                                "value": "account_support"
                            },
                            {
                                "id": "orders",
                                "text": "Orders & Shipping",
                                "value": "order_support"
                            },
                            {
                                "id": "other",
                                "text": "Something else",
                                "value": "other_support"
                            }
                        ]
                    }
                }
            },
            regular: {
                "output": "This is a regular text message response from the AI assistant. You can also try typing 'articles', 'guides', 'contact', 'survey', 'products', 'services', 'help', or 'support' to see interactive messages!"
            }
        };

        // Mock webhook endpoint
        async function mockWebhook(data) {
            const prompt = data.prompt.toLowerCase();
            
            // Handle canned response selections with specific responses
            if (prompt === 'billing_inquiry') {
                return { output: "I'd be happy to help with your billing question! You can view your invoices in your account dashboard, or let me know what specific billing issue you're experiencing." };
            } else if (prompt === 'technical_support') {
                return { output: "I'm here to help with technical issues! Please describe the problem you're experiencing and I'll do my best to assist you or connect you with our technical team." };
            } else if (prompt === 'general_info') {
                return { output: "I can provide general information about our services, features, pricing, and more. What would you like to know more about?" };
            } else if (prompt === 'account_support') {
                return { output: "I can help you with account-related questions like updating your profile, changing passwords, managing preferences, or account settings. What do you need assistance with?" };
            } else if (prompt === 'order_support') {
                return { output: "I can help you track your orders, modify shipping details, process returns, or answer questions about delivery. What order-related question do you have?" };
            } else if (prompt === 'other_support') {
                return { output: "I'm here to help with any other questions or concerns you might have. Please tell me more about what you need assistance with!" };
            
            // Handle keyword-based triggers for interactive messages (original behavior)
            } else if (prompt.includes('article')) {
                return mockWebhookResponses.articles;
            } else if (prompt.includes('guide')) {
                return mockWebhookResponses.guides;
            } else if (prompt.includes('contact') || prompt.includes('form')) {
                return mockWebhookResponses['contact-form'];
            } else if (prompt.includes('survey') || prompt.includes('feedback')) {
                return mockWebhookResponses['survey-form'];
            } else if (prompt.includes('product') || prompt.includes('shop')) {
                return mockWebhookResponses['product-cards'];
            } else if (prompt.includes('service')) {
                return mockWebhookResponses['service-cards'];
            } else if (prompt.includes('help') || prompt.includes('quick') || prompt.includes('replies')) {
                return mockWebhookResponses['quick-replies'];
            } else if (prompt.includes('support') || prompt.includes('options')) {
                return mockWebhookResponses['support-options'];
            } else {
                return mockWebhookResponses.regular;
            }
        }

        // Simulate interactive messages for demo buttons
        window.simulateInteractiveMessage = function(type) {
            console.log(`Simulating ${type} message type`);
            
            // Ensure chat is open and handle timing properly
            if (!window.chatWidget.isOpen) {
                window.chatWidget.toggle();
                // Wait for CSS transition to complete (messages become visible after 400ms)
                setTimeout(() => {
                    addMessageToChat(type);
                }, 450);
            } else {
                addMessageToChat(type);
            }
        };

        // Helper function to add message to chat
        function addMessageToChat(type) {
            const response = mockWebhookResponses[type];
            
            const aiMessage = {
                isUser: false,
                timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
            };

            if (response.content_type && response.content) {
                aiMessage.interactive = response;
            } else {
                aiMessage.text = response.output;
            }

            window.chatWidget.messages.push(aiMessage);
            window.chatWidget.updateMessages();
        }

        // Simple widget implementation for demo
        class ChatWidget {
            constructor(container, options) {
                this.container = container;
                this.options = options;
                this.messages = [];
                this.isOpen = false;
                this.render();
            }

            generateColorVariations(baseColor) {
                return {
                    primary: baseColor,
                    primaryHover: baseColor === "#242424" ? "#333333" : baseColor,
                    primaryLight: baseColor === "#242424" ? "rgba(36, 36, 36, 0.8)" : `${baseColor}cc`,
                };
            }

            render() {
                const color = this.options.color || "#242424";
                const colorVars = this.generateColorVariations(color);
                
                // Check if widget already exists
                const existingWidget = this.container.querySelector('.chat-widget');
                
                if (existingWidget) {
                    // Update existing widget state and styles
                    existingWidget.setAttribute('data-open', this.isOpen);
                    existingWidget.style.setProperty('--widget-primary-color', colorVars.primary);
                    existingWidget.style.setProperty('--widget-primary-hover', colorVars.primaryHover);
                    existingWidget.style.setProperty('--widget-primary-light', colorVars.primaryLight);
                    
                    // Update only the messages content
                    this.updateMessages();
                } else {
                    // Initial render - create the entire widget
                    this.container.innerHTML = `
                        <div class="chat-widget" data-open="${this.isOpen}" style="
                            --widget-primary-color: ${colorVars.primary};
                            --widget-primary-hover: ${colorVars.primaryHover};
                            --widget-primary-light: ${colorVars.primaryLight};
                        ">
                            <button class="chat-toggle-button" onclick="chatWidget.toggle()">
                                <svg class="chat-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path>
                                </svg>
                            </button>
                            <div class="chat-interface">
                                <div class="chat-header">
                                    <h3>${this.options.title}</h3>
                                    <button class="close-button" onclick="chatWidget.close()">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                                <div class="chat-messages" id="chat-messages">
                                    ${this.renderMessages()}
                                </div>
                                <div class="chat-input">
                                    <input type="text" id="chat-input" placeholder="Type your message..." onkeydown="if(event.key==='Enter') chatWidget.sendMessage()">
                                    <button onclick="chatWidget.sendMessage()">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22,2 15,22 11,13 2,9 22,2"></polygon>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            updateMessages() {
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    // Store current scroll position
                    const wasAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 50;
                    
                    // Update messages content
                    messagesContainer.innerHTML = this.renderMessages();
                    
                    // Only auto-scroll if user was at bottom or if this is a new message
                    if (wasAtBottom) {
                        requestAnimationFrame(() => {
                            messagesContainer.scrollTo({
                                top: messagesContainer.scrollHeight,
                                behavior: 'smooth'
                            });
                        });
                    }
                }
            }

            renderMessages() {
                if (this.messages.length === 0) {
                    return `<div class="welcome-message"><p>${this.options.initialMessage}</p></div>`;
                }
                
                return this.messages.map(msg => {
                    if (msg.interactive) {
                        return this.renderInteractiveMessage(msg);
                    }
                    const agentNamePrefix = !msg.isUser && this.options.agentName ? 
                        `<span class="agent-name">${this.options.agentName}: </span>` : '';
                    return `
                        <div class="message ${msg.isUser ? 'user-message' : 'ai-message'}">
                            <div class="message-bubble">${agentNamePrefix}${msg.text}</div>
                            <div class="message-time">${msg.timestamp}</div>
                        </div>
                    `;
                }).join('');
            }

            renderInteractiveMessage(msg) {
                const content = msg.interactive;
                
                // Special handling for canned responses and quick replies - render without bubble and timestamp
                if ((content.content_type === 'canned_response' || content.content_type === 'quick_reply') && content.content_attributes?.responses) {
                    return this.renderCannedResponseMessage(content);
                }
                
                if (content.content_type === 'article' && content.content_attributes?.items) {
                    const articles = content.content_attributes.items.map(item => `
                        <div class="article-item">
                            <div class="article-content">
                                <h4 class="article-title">${item.title}</h4>
                                <p class="article-description">${item.description}</p>
                            </div>
                            <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="article-link">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m9 18 6-6-6-6"/>
                                </svg>
                            </a>
                        </div>
                    `).join('');

                    return `
                        <div class="message ai-message">
                            <div class="message-bubble">
                                <div class="interactive-articles">
                                    <div class="interactive-articles-header">
                                        <span class="interactive-articles-title">${content.content}</span>
                                    </div>
                                    <div class="articles-list">
                                        ${articles}
                                    </div>
                                </div>
                            </div>
                            <div class="message-time">${msg.timestamp}</div>
                        </div>
                    `;
                }
                
                if (content.content_type === 'form' && content.content_attributes?.form) {
                    return this.renderFormMessage(content, msg.timestamp);
                }
                
                if (content.content_type === 'card' && content.content_attributes?.cards) {
                    return this.renderCardMessage(content, msg.timestamp);
                }
                
                return `
                    <div class="message ai-message">
                        <div class="message-bubble">
                            <div class="interactive-message-fallback">
                                <p>Interactive content: ${content.content}</p>
                            </div>
                        </div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>
                `;
            }

            renderFormMessage(content, timestamp) {
                const form = content.content_attributes.form;
                const formId = `form-${Date.now()}`;
                
                const fields = form.fields.map(field => {
                    switch (field.type) {
                        case 'text':
                        case 'email':
                        case 'tel':
                            return `
                                <div class="form-field">
                                    <label for="${field.id}" class="form-label">
                                        ${field.label}
                                        ${field.required ? '<span class="required">*</span>' : ''}
                                    </label>
                                    <input 
                                        id="${field.id}" 
                                        type="${field.type}" 
                                        placeholder="${field.placeholder || ''}" 
                                        class="form-input"
                                        ${field.required ? 'required' : ''}
                                    />
                                </div>
                            `;
                        case 'textarea':
                            return `
                                <div class="form-field">
                                    <label for="${field.id}" class="form-label">
                                        ${field.label}
                                        ${field.required ? '<span class="required">*</span>' : ''}
                                    </label>
                                    <textarea 
                                        id="${field.id}" 
                                        placeholder="${field.placeholder || ''}" 
                                        class="form-textarea"
                                        rows="3"
                                        ${field.required ? 'required' : ''}
                                    ></textarea>
                                </div>
                            `;
                        case 'select':
                            const options = field.options?.map(opt => 
                                `<option value="${opt.value}">${opt.label}</option>`
                            ).join('') || '';
                            return `
                                <div class="form-field">
                                    <label for="${field.id}" class="form-label">
                                        ${field.label}
                                        ${field.required ? '<span class="required">*</span>' : ''}
                                    </label>
                                    <select id="${field.id}" class="form-select" ${field.required ? 'required' : ''}>
                                        <option value="">Select an option</option>
                                        ${options}
                                    </select>
                                </div>
                            `;
                        case 'checkbox':
                            return `
                                <div class="form-field form-field-checkbox">
                                    <label for="${field.id}" class="form-label-checkbox">
                                        <input id="${field.id}" type="checkbox" class="form-checkbox" />
                                        <span class="checkmark"></span>
                                        ${field.label}
                                    </label>
                                </div>
                            `;
                        case 'radio':
                            const radioOptions = field.options?.map((opt, idx) => `
                                <label class="form-label-radio">
                                    <input type="radio" name="${field.id}" value="${opt.value}" class="form-radio" ${field.required ? 'required' : ''} />
                                    <span class="radio-mark"></span>
                                    ${opt.label}
                                </label>
                            `).join('') || '';
                            return `
                                <div class="form-field">
                                    <fieldset class="form-fieldset">
                                        <legend class="form-label">
                                            ${field.label}
                                            ${field.required ? '<span class="required">*</span>' : ''}
                                        </legend>
                                        ${radioOptions}
                                    </fieldset>
                                </div>
                            `;
                        default:
                            return '';
                    }
                }).join('');

                return `
                    <div class="message ai-message">
                        <div class="message-bubble">
                            <div class="interactive-form">
                                <div class="form-header">
                                    <h4 class="form-title">${form.title || content.content}</h4>
                                    ${form.description ? `<p class="form-description">${form.description}</p>` : ''}
                                </div>
                                <form class="form-content" onsubmit="return chatWidget.handleFormSubmit(event, '${formId}')">
                                    ${fields}
                                    <button type="submit" class="form-submit-button">
                                        ${form.submitLabel || 'Submit'}
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
            }

            handleFormSubmit(event, formId) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                
                // Show success message
                form.innerHTML = `
                    <div class="form-success">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22,4 12,14.01 9,11.01"></polyline>
                        </svg>
                        <span>Form submitted successfully!</span>
                    </div>
                `;
                
                console.log('Form submitted with data:', data);
                return false;
            }

            renderCardMessage(content, timestamp) {
                const cards = content.content_attributes.cards;
                const cardItems = cards.cards.map((card, index) => `
                    <div class="card-item" onclick="if('${card.link}') window.open('${card.link}', '_blank')">
                        <div class="card-image-container">
                            <img 
                                src="${card.image}" 
                                alt="${card.imageAlt || card.title}"
                                class="card-image"
                                loading="lazy"
                                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDIwMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTIwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04NyA0OC41TDk3IDU4LjVMMTEzIDQyLjVNNjcgNzcuNUg5N001NyA5Ny41SDE0M1YyMi5INTdWOTcuNVoiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+'; this.alt='Image not available';"
                            />
                            ${card.badge ? `<span class="card-badge">${card.badge}</span>` : ''}
                            ${card.price ? `<span class="card-price">${card.price}</span>` : ''}
                        </div>
                        <div class="card-content">
                            <h4 class="card-title">${card.title}</h4>
                            <p class="card-description">${card.description}</p>
                            ${card.link ? `
                                <a href="${card.link}" target="_blank" rel="noopener noreferrer" class="card-link" onclick="event.stopPropagation()">
                                    ${card.linkText || 'Learn More'}
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15,3 21,3 21,9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="message ai-message">
                        <div class="message-bubble">
                            <div class="interactive-cards">
                                <div class="interactive-cards-header">
                                    <span class="interactive-cards-title">${cards.title || content.content}</span>
                                    ${cards.description ? `<p class="interactive-cards-description">${cards.description}</p>` : ''}
                                </div>
                                <div class="cards-list">
                                    ${cardItems}
                                </div>
                            </div>
                        </div>
                        <div class="message-time">${timestamp}</div>
                    </div>
                `;
            }

            toggle() {
                this.isOpen = !this.isOpen;
                
                // Just update the state without full rebuild
                const existingWidget = this.container.querySelector('.chat-widget');
                if (existingWidget) {
                    existingWidget.setAttribute('data-open', this.isOpen);
                } else {
                    this.render(); // Only full render if widget doesn't exist
                }
            }

            close() {
                this.isOpen = false;
                
                // Just update the state without full rebuild
                const existingWidget = this.container.querySelector('.chat-widget');
                if (existingWidget) {
                    existingWidget.setAttribute('data-open', this.isOpen);
                } else {
                    this.render(); // Only full render if widget doesn't exist
                }
            }

            async sendMessage(messageText = null) {
                let text = messageText;
                
                if (!text) {
                    const input = document.getElementById('chat-input');
                    text = input.value.trim();
                    if (!text) return;
                    input.value = '';
                }

                // Add user message (only if not already added by canned response handler)
                if (!messageText) {
                    this.messages.push({
                        text,
                        isUser: true,
                        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                    });
                }

                this.updateMessages();

                // Simulate AI response
                try {
                    const response = await mockWebhook({ prompt: text });
                    
                    const aiMessage = {
                        isUser: false,
                        timestamp: new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                    };

                    if (response.content_type && response.content) {
                        aiMessage.interactive = response;
                    } else {
                        aiMessage.text = response.output;
                    }

                    this.messages.push(aiMessage);
                    this.updateMessages();
                } catch (error) {
                    console.error('Error:', error);
                }
            }

            renderCannedResponseMessage(content) {
                const responses = content.content_attributes.responses;
                
                const responseButtons = responses.responses.map(response => `
                    <button class="response-button" onclick="this.dispatchEvent(new CustomEvent('cannedResponseSelected', {
                        detail: { id: '${response.id}', text: '${response.text}', value: '${response.value || response.text}' },
                        bubbles: true
                    }))">
                        <span class="response-text">${response.text}</span>
                        <svg class="response-icon" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                    </button>
                `).join('');

                return `
                    <div class="canned-response-container">
                        <div class="interactive-canned-responses">
                            <div class="interactive-responses-header">
                                <p class="interactive-responses-description">Choose an option below or type your own message:</p>
                            </div>
                            <div class="responses-list">
                                ${responseButtons}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Function to change widget color
        function changeWidgetColor(color) {
            if (window.chatWidget) {
                window.chatWidget.options.color = color;
                window.chatWidget.render();
            }
        }
        
        // Initialize the chat widget
        const container = document.createElement('div');
        document.body.appendChild(container);
        
        window.chatWidget = new ChatWidget(container, {
            title: "Interactive Demo Bot",
            initialMessage: "Hi! I can send interactive messages including articles, forms, cards, and quick replies. Try typing 'articles', 'guides', 'contact', 'survey', 'products', 'services', 'help', or 'support' to see them in action!",
            color: "#242424",
            agentName: "Demo Bot"
        });
        
        // Handle canned response selections
        document.addEventListener('cannedResponseSelected', function(event) {
            console.log('Canned response selected:', event.detail);
            
            // Simulate user selecting the response by adding it as a user message
            // and then sending it to get an AI response
            if (window.chatWidget) {
                // Add the user's selection as a message
                const userMessage = {
                    id: Date.now().toString(),
                    text: event.detail.text,
                    isUser: true,
                    timestamp: new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
                };
                
                window.chatWidget.messages.push(userMessage);
                window.chatWidget.updateMessages();
                
                // Send the selected value to get AI response
                setTimeout(() => {
                    window.chatWidget.sendMessage(event.detail.value || event.detail.text);
                }, 500);
            }
        });
    </script>
</body>
</html> 